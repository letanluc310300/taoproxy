#!/usr/bin/env bash
set -Eeuo pipefail

# =========================
#  CREATE SQUID PROXY (AUTH)
#  - Random port
#  - Optional custom username
#  - Optional Telegram send
#  - Works on Ubuntu/Debian
# =========================

# ---------- Helpers ----------
die() { echo "‚ùå $*" >&2; exit 1; }
need_root() { [[ "${EUID:-$(id -u)}" -eq 0 ]] || die "H√£y ch·∫°y b·∫±ng root: sudo bash $0"; }

command_exists() { command -v "$1" >/dev/null 2>&1; }

gen_pass() {
  # 10 k√Ω t·ª± A-Za-z0-9
  tr -dc 'A-Za-z0-9' </dev/urandom | head -c 10
}

get_public_ipv4() {
  # nhi·ªÅu ngu·ªìn fallback
  local ip=""
  for url in "https://ifconfig.me" "https://api.ipify.org" "https://ipv4.icanhazip.com"; do
    ip="$(curl -fsS -4 --max-time 8 "$url" 2>/dev/null | tr -d ' \n\r' || true)"
    [[ "$ip" =~ ^([0-9]{1,3}\.){3}[0-9]{1,3}$ ]] && { echo "$ip"; return 0; }
  done
  echo "UNKNOWN"
}

random_port() {
  # random 2000-65000, c·ªë g·∫Øng tr√°nh port ƒë√£ d√πng
  local p
  for _ in {1..50}; do
    p=$((RANDOM % 63000 + 2000))
    if ! ss -lnt 2>/dev/null | awk '{print $4}' | grep -qE ":${p}\$"; then
      echo "$p"
      return 0
    fi
  done
  echo $((RANDOM % 63000 + 2000))
}

# ---------- Main ----------
need_root

echo "===================================="
echo "  üß∞ CREATE PROXY (SQUID AUTH)"
echo "===================================="

# Telegram config (optional)
BOT_TOKEN="$7737030927:AAEmdQNSxxKE7HgnhyOAORuqoRYMFcPnWGc"
CHAT_ID="$6267128183"

# Ask user/pass
read -r -p "B·∫°n mu·ªën nh·∫≠p username? (y/n): " choice
choice="${choice:-n}"

USERNAME="kingproxy"
PASSWORD="kingproxy"

if [[ "$choice" =~ ^[Yy]$ ]]; then
  read -r -p "Nh·∫≠p username: " USERNAME
  USERNAME="${USERNAME:-kingproxy}"
  PASSWORD="$(gen_pass)"
fi

read -r -p "B·∫°n c√≥ mu·ªën g·ª≠i th√¥ng tin proxy v·ªÅ Telegram? (y/n): " send_tele
send_tele="${send_tele:-n}"

# Install packages
export DEBIAN_FRONTEND=noninteractive

echo "üîÑ C√†i ƒë·∫∑t g√≥i c·∫ßn thi·∫øt (squid apache2-utils curl)..."
apt-get update -y
apt-get install -y squid apache2-utils curl >/dev/null

# Create auth file
PASSWD_FILE="/etc/squid/passwd"
mkdir -p /etc/squid

echo "üë§ T·∫°o user x√°c th·ª±c..."
htpasswd -bc "$PASSWD_FILE" "$USERNAME" "$PASSWORD" >/dev/null

# Configure squid
SQUID_CONF="/etc/squid/squid.conf"
BACKUP="/etc/squid/squid.conf.bak.$(date +%Y%m%d_%H%M%S)"

if [[ -f "$SQUID_CONF" ]]; then
  cp -f "$SQUID_CONF" "$BACKUP"
fi

PORT="$(random_port)"

cat > "$SQUID_CONF" <<EOF
# ==== Auto generated by creatproxy.sh ====
auth_param basic program /usr/lib/squid/basic_ncsa_auth $PASSWD_FILE
auth_param basic realm ProxyKing
acl authenticated proxy_auth REQUIRED
http_access allow authenticated

# Listen
http_port $PORT

# Hardening / minimal cache
cache deny all
access_log /var/log/squid/access.log
EOF

echo "üöÄ Restart squid..."
systemctl enable squid >/dev/null 2>&1 || true
systemctl restart squid

# Get IP
IP="$(get_public_ipv4)"

echo "===================================="
echo " ‚úÖ Proxy ƒë√£ t·∫°o th√†nh c√¥ng"
echo "    ƒê·ªãnh d·∫°ng: $IP:$PORT:$USERNAME:$PASSWORD"
echo "===================================="

# Telegram send
if [[ "$send_tele" =~ ^[Yy]$ ]]; then
  if [[ "$BOT_TOKEN" == "YOUR_BOT_TOKEN" || "$CHAT_ID" == "YOUR_CHAT_ID" ]]; then
    echo "‚ö†Ô∏è B·∫°n ch∆∞a set BOT_TOKEN/CHAT_ID n√™n b·ªè qua g·ª≠i Telegram."
  else
    MESSAGE="‚úÖ Proxy m·ªõi ƒë√£ ƒë∆∞·ª£c t·∫°o:
ƒê·ªãnh d·∫°ng: ${IP}:${PORT}:${USERNAME}:${PASSWORD}"
    curl -fsS -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
      -d chat_id="$CHAT_ID" \
      -d text="$MESSAGE" >/dev/null \
      && echo "üì© ƒê√£ g·ª≠i Telegram." || echo "‚ö†Ô∏è G·ª≠i Telegram th·∫•t b·∫°i."
  fi
fi

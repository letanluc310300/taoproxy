#!/usr/bin/env bash
set -Eeuo pipefail

# =========================
#  createproxy.sh (Improved)
# =========================

# === Telegram Bot Config (ch·ªâ d√πng n·∫øu ch·ªçn g·ª≠i) ===
BOT_TOKEN="$7737030927:AAEmdQNSxxKE7HgnhyOAORuqoRYMFcPnWGc"
CHAT_ID="$6267128183"

# === Default user/pass n·∫øu kh√¥ng nh·∫≠p ===
DEFAULT_USER="kingproxy"
DEFAULT_PASS="kingproxy"

# === Squid config ===
SQUID_CONF="/etc/squid/squid.conf"
SQUID_PASSWD="/etc/squid/passwd"
SQUID_LOG="/var/log/squid/access.log"

# ===== Helpers =====
RED=$'\e[31m'; GRN=$'\e[32m'; YEL=$'\e[33m'; CYN=$'\e[36m'; RST=$'\e[0m'
log()  { echo "${CYN}[*]${RST} $*"; }
ok()   { echo "${GRN}[‚úì]${RST} $*"; }
warn() { echo "${YEL}[!]${RST} $*"; }
die()  { echo "${RED}[x]${RST} $*" >&2; exit 1; }

cleanup_on_error() {
  warn "C√≥ l·ªói x·∫£y ra. B·∫°n c√≥ th·ªÉ xem log/systemctl status squid ƒë·ªÉ bi·∫øt th√™m."
}
trap cleanup_on_error ERR

need_root() {
  if [[ "${EUID:-$(id -u)}" -ne 0 ]]; then
    die "Vui l√≤ng ch·∫°y b·∫±ng root: sudo bash createproxy.sh"
  fi
}

have_cmd() { command -v "$1" >/dev/null 2>&1; }

detect_pkg_mgr() {
  if have_cmd apt-get; then
    echo "apt"
  elif have_cmd yum; then
    echo "yum"
  elif have_cmd dnf; then
    echo "dnf"
  else
    echo ""
  fi
}

install_packages() {
  local pmgr
  pmgr="$(detect_pkg_mgr)"
  [[ -n "$pmgr" ]] || die "Kh√¥ng t√¨m th·∫•y tr√¨nh qu·∫£n l√Ω g√≥i (apt/yum/dnf)."

  log "C√†i ƒë·∫∑t g√≥i c·∫ßn thi·∫øt: squid + apache2-utils + curl"
  if [[ "$pmgr" == "apt" ]]; then
    export DEBIAN_FRONTEND=noninteractive
    apt-get update -y
    apt-get install -y squid apache2-utils curl
  elif [[ "$pmgr" == "yum" ]]; then
    yum install -y squid httpd-tools curl
  elif [[ "$pmgr" == "dnf" ]]; then
    dnf install -y squid httpd-tools curl
  fi
  ok "C√†i ƒë·∫∑t xong"
}

find_basic_auth_bin() {
  # c√°c ƒë∆∞·ªùng d·∫´n ph·ªï bi·∫øn
  local candidates=(
    "/usr/lib/squid/basic_ncsa_auth"
    "/usr/lib64/squid/basic_ncsa_auth"
    "/usr/lib/squid3/basic_ncsa_auth"
    "/usr/libexec/squid/basic_ncsa_auth"
    "/usr/libexec/basic_ncsa_auth"
  )
  for p in "${candidates[@]}"; do
    if [[ -x "$p" ]]; then
      echo "$p"
      return 0
    fi
  done

  # fallback: t√¨m nhanh
  local found
  found="$(find /usr -type f -name basic_ncsa_auth 2>/dev/null | head -n 1 || true)"
  [[ -n "$found" && -x "$found" ]] && { echo "$found"; return 0; }

  return 1
}

random_port() {
  # ∆∞u ti√™n port ng·∫´u nhi√™n nh∆∞ng ƒë·∫£m b·∫£o ch∆∞a d√πng
  local port
  for _ in {1..50}; do
    port=$((RANDOM % 63000 + 2000))
    if ! ss -lnt 2>/dev/null | awk '{print $4}' | grep -q ":$port$"; then
      echo "$port"
      return 0
    fi
  done
  # fallback n·∫øu xui
  echo "3128"
}

get_public_ipv4() {
  # ifconfig.me ƒë√¥i khi ch·∫≠p ch·ªùn -> c√≥ fallback
  local ip=""
  ip="$(curl -fsS -4 --max-time 8 ifconfig.me 2>/dev/null || true)"
  if [[ -z "$ip" ]]; then
    ip="$(curl -fsS -4 --max-time 8 api.ipify.org 2>/dev/null || true)"
  fi
  if [[ -z "$ip" ]]; then
    ip="$(curl -fsS -4 --max-time 8 icanhazip.com 2>/dev/null || true)"
  fi
  echo "${ip//[$'\r\n ']/}"
}

backup_conf() {
  if [[ -f "$SQUID_CONF" ]]; then
    cp -a "$SQUID_CONF" "${SQUID_CONF}.bak.$(date +%Y%m%d_%H%M%S)"
    ok "ƒê√£ backup squid.conf"
  fi
}

write_squid_conf() {
  local auth_bin="$1"
  local port="$2"

  mkdir -p "$(dirname "$SQUID_PASSWD")"
  mkdir -p "$(dirname "$SQUID_LOG")"

  cat > "$SQUID_CONF" <<EOF
# ===== Auto-generated by createproxy.sh =====
# Basic authentication
auth_param basic program $auth_bin $SQUID_PASSWD
auth_param basic realm ProxyKing
acl authenticated proxy_auth REQUIRED

# Access rules
http_access allow authenticated
http_access deny all

# Listen port
http_port $port

# No caching
cache deny all

# Logging
access_log $SQUID_LOG
EOF

  ok "ƒê√£ ghi c·∫•u h√¨nh Squid"
}

create_user() {
  local user="$1"
  local pass="$2"

  # -b: batch mode; -c: create file; d√πng -c ch·ªâ khi file ch∆∞a t·ªìn t·∫°i
  if [[ -f "$SQUID_PASSWD" ]]; then
    htpasswd -b "$SQUID_PASSWD" "$user" "$pass" >/dev/null
  else
    htpasswd -bc "$SQUID_PASSWD" "$user" "$pass" >/dev/null
  fi
  ok "ƒê√£ t·∫°o user x√°c th·ª±c"
}

restart_squid() {
  # service name c√≥ th·ªÉ l√† squid ho·∫∑c squid3
  if systemctl list-unit-files | grep -q '^squid\.service'; then
    systemctl enable --now squid >/dev/null 2>&1 || true
    systemctl restart squid
    systemctl is-active --quiet squid || die "Squid kh√¥ng ch·∫°y (squid)."
  elif systemctl list-unit-files | grep -q '^squid3\.service'; then
    systemctl enable --now squid3 >/dev/null 2>&1 || true
    systemctl restart squid3
    systemctl is-active --quiet squid3 || die "Squid kh√¥ng ch·∫°y (squid3)."
  else
    # fallback
    systemctl restart squid 2>/dev/null || systemctl restart squid3 2>/dev/null || die "Kh√¥ng restart ƒë∆∞·ª£c Squid."
  fi
  ok "Squid ƒë√£ restart"
}

send_telegram() {
  local ip="$1" port="$2" user="$3" pass="$4"

  # n·∫øu user ch∆∞a set token/chat id th√¨ b·ªè qua ƒë·ªÉ tr√°nh fail
  if [[ "$BOT_TOKEN" == "YOUR_BOT_TOKEN" || "$CHAT_ID" == "YOUR_CHAT_ID" ]]; then
    warn "B·∫°n ch·ªçn g·ª≠i Telegram nh∆∞ng BOT_TOKEN/CHAT_ID ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh. B·ªè qua."
    return 0
  fi

  local msg
  msg="‚úÖ Proxy m·ªõi ƒë√£ ƒë∆∞·ª£c t·∫°o:
ƒê·ªãnh d·∫°ng: ${ip}:${port}:${user}:${pass}"

  curl -fsS -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
    -d "chat_id=${CHAT_ID}" \
    -d "text=${msg}" >/dev/null || warn "G·ª≠i Telegram th·∫•t b·∫°i (token/chat id/network)."
  ok "ƒê√£ g·ª≠i Telegram"
}

# ===== Main =====
need_root
install_packages

# ==== h·ªèi user/pass ====
read -r -p "B·∫°n mu·ªën nh·∫≠p username? (y/n): " choice
if [[ "$choice" =~ ^[yY]$ ]]; then
  read -r -p "Nh·∫≠p username: " USERNAME
  # random pass 10 k√Ω t·ª±
  PASSWORD="$(tr -dc A-Za-z0-9 </dev/urandom | head -c 10)"
  [[ -n "${USERNAME// }" ]] || die "Username r·ªóng."
else
  USERNAME="$DEFAULT_USER"
  PASSWORD="$DEFAULT_PASS"
fi

# ==== h·ªèi g·ª≠i telegram ====
read -r -p "B·∫°n c√≥ mu·ªën g·ª≠i th√¥ng tin proxy v·ªÅ Telegram? (y/n): " send_tele

# ==== ch·ªçn port ====
PORT="$(random_port)"

# ==== t√¨m basic_ncsa_auth ====
AUTH_BIN="$(find_basic_auth_bin || true)"
[[ -n "$AUTH_BIN" ]] || die "Kh√¥ng t√¨m th·∫•y basic_ncsa_auth. H√£y ki·ªÉm tra c√†i squid ƒë√∫ng ch∆∞a."

# ==== t·∫°o user ====
create_user "$USERNAME" "$PASSWORD"

# ==== ghi config ====
backup_conf
write_squid_conf "$AUTH_BIN" "$PORT"
restart_squid

# ==== l·∫•y ip ====
IP="$(get_public_ipv4)"
[[ -n "$IP" ]] || warn "Kh√¥ng l·∫•y ƒë∆∞·ª£c IP c√¥ng khai IPv4. B·∫°n c√≥ th·ªÉ t·ª± ki·ªÉm tra b·∫±ng: curl -4 ifconfig.me"

# ==== in k·∫øt qu·∫£ ====
echo "===================================="
echo " ‚úÖ Proxy ƒë√£ t·∫°o th√†nh c√¥ng"
echo "    ƒê·ªãnh d·∫°ng: ${IP:-UNKNOWN_IP}:$PORT:$USERNAME:$PASSWORD"
echo
echo " üåê IP: ${IP:-UNKNOWN_IP}"
echo " üîå PORT: $PORT"
echo " üë§ USER: $USERNAME"
echo " üîë PASS: $PASSWORD"
echo "===================================="

# ==== g·ª≠i telegram n·∫øu ch·ªçn ====
if [[ "$send_tele" =~ ^[yY]$ ]]; then
  send_telegram "${IP:-UNKNOWN_IP}" "$PORT" "$USERNAME" "$PASSWORD"
fi
